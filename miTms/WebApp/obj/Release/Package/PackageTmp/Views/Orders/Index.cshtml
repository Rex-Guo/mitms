@model IEnumerable<WebApp.Models.Order>
@{
    ViewBag.Title = "订单信息";
}
<style lang="scss">

    .tangram-suggestion {
        z-index: 9999;
    }
</style>
<!-- MAIN CONTENT -->
<div id="content">
    <!-- quick navigation bar -->
    <div class="row">
        <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
            <h1 class="page-title txt-color-blueDark">
                <i class="fa fa-table fa-fw "></i>
                @{
                    //TODO:fix quick navigation path
                }
                业务操作
                <span>
                    >
                    订单信息
                </span>
            </h1>
        </div>
        <div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">

        </div>
    </div>
    <!-- end quick navigation bar -->
    <!-- widget grid -->
    <section id="widget-grid" class="">
        <!-- row -->
        <div class="row">
            <!-- NEW WIDGET START -->
            <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <!-- Widget ID (each widget will need unique ID)-->
                <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">
                    <!-- widget options:
                    usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">
                    data-widget-colorbutton="false"
                    data-widget-editbutton="false"
                    data-widget-togglebutton="false"
                    data-widget-deletebutton="false"
                    data-widget-fullscreenbutton="false"
                    data-widget-custombutton="false"
                    data-widget-collapsed="true"
                    data-widget-sortable="false"
                    -->
                    <header>
                        <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                        <h2>订单信息</h2>
                    </header>

                    <!-- widget div-->
                    <div>
                        <!-- widget edit box -->
                        <div class="jarviswidget-editbox">
                            <!-- This area used as dropdown edit box -->
                        </div>
                        <!-- end widget edit box -->
                        <!-- widget content -->
                        <div class="widget-body no-padding">

                            <div class="alert alert-warning no-margin fade in">
                                <button class="close" data-dismiss="alert">
                                    ×
                                </button>
                                <i class="fa-fw fa fa-info"></i>
                                所有货源信息请必须确保信息的真实性
                            </div>
                            <!--begin datagrid-content -->
                            <div class="table-responsive">
                                <table id="orders_datagrid"></table>
                                <div id="orders_toolbar" style="height:auto">
                                    @{
                                        //TODO: enable authorization
                                    }
                                    @*@if (Html.IsAuthorize("Create"))
                                        {
                                            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-plus fa-fw',plain:true" onclick="append()">新增</a>
                                        }
                                        @if (Html.IsAuthorize("Delete"))
                                        {
                                        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-trash-o fa-fw',plain:true" onclick="removeit()">删除</a>
                                        }
                                        @if (Html.IsAuthorize("Edit"))
                                        {
                                            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-floppy-o fa-fw',plain:true" onclick="accept()">保存</a>
                                            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-undo fa-fw',plain:true" onclick="reject()">取消</a>
                                        }
                                        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-refresh fa-fw',plain:true" onclick="reload()">刷新</a>
                                        @if (Html.IsAuthorize("Import"))
                                        {
                                             <a href="javascript:void(0)" class="easyui-menubutton" data-options="menu:'#importmenu',iconCls:'fa fa-upload fa-fw' " onclick="importexcel()">导入数据</a>
                                                   <div id="importmenu" style="width:150px;">
                                                            <div data-options="iconCls:'fa fa-file-excel-o fa-fw'" onclick="importexcel()">导入数据</div>
                                                            <div data-options="iconCls:'fa fa-cloud-download fa-fw'" onclick="downloadtemplate()" >下载用于导入的模板</div>
                                                    </div>
                                             <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-cloud-download fa-fw',plain:true" onclick="exportexcel()">导出至Excel</a>
                                        }*@
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-plus fa-fw',plain:true" onclick="append()">新增</a>
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-truck fa-fw',plain:true" onclick="shipping()">发运</a>
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-trash-o fa-fw',plain:true" onclick="removeit()">删除</a>
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-floppy-o fa-fw',plain:true" onclick="accept()">保存</a>
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-undo fa-fw',plain:true" onclick="reject()">取消</a>
                                    <a href="javascript:void(0)" class="easyui-menubutton" data-options="menu:'#importmenu',iconCls:'fa fa-upload fa-fw' " onclick="importexcel()">导入数据</a>
                                    <div id="importmenu" style="width:150px;">
                                        <div data-options="iconCls:'fa fa-file-excel-o fa-fw'" onclick="importexcel()">导入数据</div>
                                        <div data-options="iconCls:'fa fa-cloud-download fa-fw'" onclick="downloadtemplate()">下载用于导入的模板</div>
                                    </div>
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-cloud-download fa-fw',plain:true" onclick="exportexcel()">导出至Excel</a>
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-refresh fa-fw',plain:true" onclick="reload()">刷新</a>
                                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fa fa-question-circle-o fa-fw',plain:true" onclick="dohelp()">帮助</a>
                                </div>


                            </div>
                            <!--end datagrid-content -->

                        </div>
                        <!-- end widget content -->
                    </div>
                    <!-- end widget div -->

                </div>
                <!-- end widget -->

            </article>
            <!-- WIDGET END -->

        </div>

        <!-- end row -->
    </section>
    <!-- end widget grid -->
    <!-- file upload partial view -->
    @Html.Partial("_ImportWindow", new ViewDataDictionary { { "EntityName", "Order" } })
    <!-- end file upload partial view -->
    <!-- detail popup window -->
    @*@Html.Partial("_PopupDetailFormView", new WebApp.Models.Order())*@
    <!-- end detail popup window -->
    <!-- Modal 新增订单 -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">新增订单</h4>
                </div>
                <div class="modal-body">
                    <form id="order-form" class="smart-form" novalidate="novalidate">

                        <fieldset>
                            <div class="row">
                                <section class="col col-6">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-pencil"></i>
                                        <input type="text" name="ExternalNo" id="ExternalNo" placeholder="对账单号">
                                    </label>
                                </section>
                                <section class="col col-6">
                                    <label class="select">

                                        @Html.DropDownList("ShipperId", (IEnumerable
<SelectListItem>)ViewBag.Shipper, new { @class = "form-control" })
                                        <i></i>
                                    </label>
                                </section>
                            </div>
                            <div class="row">
                                <section class="col col-6">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-map-marker"></i>
                                        <input type="text" name="Location1" id="Location1" placeholder="起点">
                                    </label>
                                </section>
                                <section class="col col-6">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-map-marker"></i>
                                        <input type="text" name="Location2" id="Location2" placeholder="终点">
                                    </label>
                                </section>

                            </div>
                            <div class="row">

                                <section class="col col-4">
                                    <label class="input">
                                        <i class="icon-append fa fa-calendar"></i>
                                        <input name="ResquestedLoadStartDatetime" id="ResquestedLoadStartDatetime" class="datepicker" data-dateformat="mm/dd/yy" placeholder="要求装货时间">
                                    </label>
                                </section>
                                <section class="col col-4">
                                    <label class="select">
                                        <select name="PriceType" id="PriceType">
                                            <option value="0" selected="" disabled="">价格类型</option>
                                            <option value="1">整车</option>
                                            <option value="2">拼车</option>
                                        </select> <i></i>
                                    </label>
                                </section>
                                <section class="col col-4">
                                    <label class="select">
                                        <select name="TimePeriod" id="TimePeriod">
                                            <option value="0" selected="" disabled="">时效</option>
                                            <option value="12">当天达</option>
                                            <option value="48">次日达</option>
                                            <option value="72">隔天达</option>

                                        </select> <i></i>
                                    </label>
                                </section>
                            </div>
                            <div class="row">

                                <section class="col col-4">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-phone"></i>
                                        <input name="Contact" id="Contact" placeholder="托运联系人">
                                    </label>
                                </section>
                                <section class="col col-4">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-phone"></i>
                                        <input name="PhoneNumber" id="PhoneNumber" placeholder="托运联系电话" data-mask="999 9999 9999">
                                    </label>
                                </section>
                                <section class="col col-4">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-map-marker"></i>
                                        <input name="LoadTransportStationName" id="LoadTransportStationName" placeholder="装货点名称">
                                    </label>
                                </section>
                            </div>
                            <div class="row">

                                <section class="col col-4">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-phone"></i>
                                        <input name="Consignee" id="Consignee" placeholder="收货人">
                                    </label>
                                </section>
                                <section class="col col-4">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-phone"></i>
                                        <input name="ConsiMobileTelephoneNumber" id="ConsiMobileTelephoneNumber" placeholder="收货人移动电话" data-mask="999 9999 9999">
                                    </label>
                                </section>
                                <section class="col col-4">
                                    <label class="input">
                                        <i class="icon-prepend fa fa-map-marker"></i>
                                        <input name="ReceiptTransportStationName" id="ReceiptTransportStationName" placeholder="卸货点">
                                    </label>
                                </section>
                            </div>
                        </fieldset>

                        <fieldset>
                            <div class="row">
                                <section class="col col-5">
                                    <label class="input">
                                        <input type="text" name="ProductName" id="ProductName" placeholder="货物名称">
                                    </label>
                                </section>

                                <section class="col col-4">
                                    <label class="input">
                                        <input type="text" name="inputloadnum" id="inputloadnum" placeholder="件数/托数/箱数">
                                    </label>
                                </section>

                                <section class="col col-3">
                                    <label class="input">
                                        <input type="text" name="inputloadsize" id="inputloadsize" placeholder="立方数/吨">
                                    </label>
                                </section>
                            </div>



                            <section>
                                <label class="textarea">
                                    <textarea rows="3" name="Requirements" id="Requirements" placeholder="额外要求"></textarea>
                                </label>
                            </section>
                        </fieldset>
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="OrderNo" name="OrderNo" value="" />
 
                        <input type="hidden" id="Id" name="Id" value="-1" />
                        <input type="hidden" id="Packages" name="Packages" value="" />
                        <input type="hidden" id="Weight" name="Weight" value="" />
                        <input type="hidden" id="Volume" name="Volume" value="" />
                        <input type="hidden" id="Cartons" name="Cartons" value="" />
                        <input type="hidden" id="Pallets" name="Pallets" value="" />
                        <input type="hidden" id="VehicleId" name="VehicleId" value="" />
                        <input type="hidden" id="CompanyId" name="CompanyId" value="@Auth.PlatformId.ToString()" />
                        <input type="hidden" id="InputUser" name="InputUser" value="@Auth.UserName" />
                    </form>
                </div>
                <div class="modal-footer">

                    <button type="button" id="createorderbtn" class="btn btn-primary">
                        保存
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!-- /.modal 新增订单 -->
    <!-- modal 关联发运单 -->
    <div id="shippingwindow" hidden="hidden" class="easyui-window"
         title="订单发运"
         data-options="modal:true,
                    closed:true,
                    iconcls:'icon-menu'
                    " style="width:960px;height:580px">
        <!--begin form表单界面-->
        <form id="shiporder_form" class="easyui-form form-horizontal" method="post" data-options="novalidate:true">
            @Html.AntiForgeryToken()
            <input type="hidden" id="InputUser1" name="InputUser" value="@Auth.UserName" />
            <input type="hidden" id="CompanyId1" name="CompanyId" value="@Auth.PlatformId" />
            <input type="hidden" id="TimePeriod1" name="TimePeriod" value="" />
            <input type="hidden" id="ItemCount1" name="ItemCount" value="" />
            <input type="hidden" id="Packages1" name="Packages" value="" />
            <input type="hidden" id="Weight1" name="Weight" value="" />
            <input type="hidden" id="Volume1" name="Volume" value="" />
            <input type="hidden" id="Pallets1" name="Pallets" value="" />
            <input type="hidden" id="Cartons1" name="Cartons" value="" />
            <input type="hidden" id="BreakCartons1" name="BreakCartons" value="" />
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <td colspan="6">
                            派车作业
                        </td>
                    </tr>
                </thead>
                <tr>

                    <td class="control-label">发运单号</td>
                    <td>
                        <input id="ShipOrderNo"
                               name="ShipOrderNo"
                               value=""
                               tabindex="1"
                               class="easyui-textbox"
                               type="text"
                               data-options="prompt:'派车单号',
								 label:'',
                                 width:200,
                                 readonly:true,
								 required:true ,validType:'length[0,20]'" />
                    </td>
                    <td class="control-label"> 派车时间 </td>
                    <td>
                        <input id="OrderDate"
                               name="OrderDate"
                               tabindex="3"
                               class="easyui-datetimebox"
                               type="text"
                               value='@DateTime.Now.ToString("yyyy-MM-dd HH:mm")'
                               data-options="prompt:'派车时间',
								 label:'',
                                 width:200,
								 required:true,
								 formatter:datetimeformatter" />
                    </td>
                    <td class="control-label">业务类型 </td>
                    <td>
                        <input id="BusinessType"
                               name="BusinessType"
                               value="0"
                               tabindex="4"
                               class="easyui-combobox"
                               type="text"
                               data-options="prompt:'业务类型',
								 label:'',
                                 width:200,
                                 valueField:'id',
                                 textField:'text',
                                 data:[{id:0,text:'干线运输'},{id:1,text:'城市配送'},{id:2,text:'集装箱运输'},{id:3,text:'农村配送'}],
								 required:true ,validType:'length[0,8]'" />
                    </td>
                </tr>
                <tr>
                    <td class="control-label"> 承运人 </td>
                    <td>
                        <input id="CarrierId"
                               name="CarrierId"
                               value=""
                               class="easyui-combobox" data-options="
						prompt:'承运人' ,
						label:'' ,
                        width:200,
						required:true ,
						valueField: 'Id',
						textField: 'Name' ,
						url: '/ShipOrders/GetCarriers' ,
						onSelect: function(item){
						    let carrierid=item.Id;
                            $('#VehicleId1').combogrid({
                                width:200,
                                panelWidth: 500,
                                prompt: '车牌号',
                                mode: 'remote',
                                idField: 'Id',
                                textField: 'PlateNumber',
                                method: 'get',
                                url: '/Orders/GetAvailableVehiclesWithCarrierId?carrierid=' + carrierid,
                                required: true,
                                columns: [[
                                    { field: 'PlateNumber', title: '车牌号', width: 120 },
                                    { field: 'CarType', title: '车型', width: 80 },
                                    { field: 'Status', title: '状态', width: 80 },
                                    { field: 'StrLoadWeight', title: '载重', width: 80, align: 'right' },
                                    { field: 'Driver', title: '司机', width: 80 },
                                    { field: 'DriverPhone', title: '司机电话', width: 80 }
                                        ]],
                                fitColumns: false,
                                onSelect: function (index, row) {
                                     $('#CarType').textbox('setValue',row.CarType);
                                     $('#Driver').textbox('setValue',row.Driver);
                                     $('#DriverPhone').textbox('setValue',row.DriverPhone);
                                }
                               })
				        }">
                    </td>
                    <td class="control-label"> 承运车 </td>
                    <td>
                        <input id="VehicleId1"
                               name="VehicleId"
                               value=""
                               class="easyui-combogrid">
                    </td>
                    <td class="control-label">车型</td>
                    <td>
                        <input id="CarType"
                               name="CarType"
                               value=""
                               tabindex="8"
                               class="easyui-textbox"
                               type="text"
                               data-options="prompt:'车辆类型',
								 label:'',
                                 width:200,
								 required:false ,validType:'length[0,20]'" />
                    </td>
                </tr>
                <tr>
                    <td class="control-label">司机</td>
                    <td>
                        <input id="Driver"
                               name="Driver"
                               value=""
                               tabindex="9"
                               class="easyui-textbox"
                               type="text"
                               data-options="prompt:'司机',
								 label:'',
                                width:200,
								 required:true ,validType:'length[0,30]'" />
                    </td>
                    <td class="control-label">司机联系电话</td>
                    <td>
                        <input id="DriverPhone"
                               name="DriverPhone"
                               value=""
                               tabindex="10"
                               class="easyui-textbox"
                               type="text"
                               data-options="prompt:'司机电话',
								 label:'',
                                width:200,
								 required:true ,validType:'length[0,18]'" />
                    </td>
                    <td class="control-label">计划发车时间  </td>
                    <td>
                        <input id="PlanDepartDate"
                               name="PlanDepartDate"
                               tabindex="18"
                               class="easyui-datetimebox"
                               type="text"
                               value='@DateTime.Now.AddHours(3).ToString("MM-dd-yyyy HH:mm")'
                               data-options="prompt:'计划发车时间',
								 label:'',
                                width:200,
								 required:true,
								 formatter:datetimeformatter" />
                    </td>
                </tr>
                <tr>
                    <td class="control-label"> 起点  </td>
                    <td>
                        <input id="Location11"
                               name="Location1"
                               value=""
                               tabindex="14"
                               class="easyui-textbox"
                               type="text"
                               data-options="prompt:'起点',
								 label:'',
                                width:200,
								 required:true ,validType:'length[0,120]'" />
                    </td>
                    <td class="control-label"> 途径地 </td>
                    <td>
                        <input id="PassLocation"
                               name="PassLocation"
                               value=""
                               tabindex="15"
                               class="easyui-textbox"
                               type="text"
                               data-options="prompt:'途径地',
								 label:'',
                                 width:200,
								 required:false ,validType:'length[0,255]'" />
                    </td>
                    <td class="control-label"> 终点 </td>
                    <td>
                        <input id="Location21"
                               name="Location2"
                               value=""
                               tabindex="15"
                               class="easyui-textbox"
                               type="text"
                               data-options="prompt:'终点',
								 label:'',
                                width:200,
								 required:true ,validType:'length[0,120]'" />
                    </td>
                </tr>
                <tr>
                    <td class="control-label"> 出货单批号 </td>
                    <td>
                        <input id="ExternalNo1"
                               name="ExternalNo"
                               tabindex="19"
                               class="easyui-textbox"
                               type="text"
                               value=''
                               data-options="prompt:'出货单批号',
								 label:'',
                                 width:200,
								 required:false
								" />
                    </td>
                    <td class="control-label"> 备注 </td>
                    <td>
                        <input id="Remark"
                               name="Remark"
                               tabindex="19"
                               class="easyui-textbox"
                               type="text"
                               value=''
                               data-options="prompt:'备注说明',
								 label:'',
                                 width:200,
								 required:false
								 " />
                    </td>
                    <td class="control-label">计划送达时间 </td>
                    <td>
                        <input id="PlanDeliveryDate"
                               name="PlanDeliveryDate"
                               tabindex="19"
                               class="easyui-datetimebox"
                               type="text"
                               value='@DateTime.Now.AddHours(48).ToString("MM-dd-yyyy HH:mm")'
                               data-options="prompt:'计划送达时间',
								 label:'',
                                width:200,
								 required:true,
								 formatter:datetimeformatter" />
                    </td>
                </tr>
                <tr>
                    <td colspan="6">
                        <table style="width:100%">
                            <tr>
                                <td>件数:<span id="p1" class="badge bg-color-greenLight">0</span></td>
                                <td>重量：<span id="p2" class="badge bg-color-greenLight">0</span></td>
                                <td>体积：<span id="p3" class="badge bg-color-greenLight">0</span></td>
                                <td>栈板数：<span id="p4" class="badge bg-color-greenLight">0</span></td>
                                <td>箱数：<span id="p5" class="badge bg-color-greenLight">0</span></td>
                                <td>散箱数：<span id="p6" class="badge bg-color-greenLight">0</span></td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

        </form>
        <!--end form表单界面-->
        <!--========================================================================================-->
        <!-- details tabs -->
        <div class="tabs-container">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs bordered">
                <li class="active"><a data-toggle="tab" href="#tab-shiporderdetails"> 发运明细 </a></li>

            </ul>
            <!-- Tab panes -->
            <div class="tab-content padding-10">
                <div id="tab-shiporderdetails" class="tab-pane active">
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table id="shiporderdetails_datagrid"></table>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--end details tabs -->
        <div id="footer" style="text-align:right;padding:5px;">

            <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" onclick="javascript:createshiporder()" style="width:80px">发运</a>
            <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="javascript:closeshiporderwindow()" style="width:80px">取消</a>
        </div>
    </div>
    <!-- END MAIN CONTENT -->

    @section Scripts {
        <script type="text/javascript">
      var entityname = "Order";

//发运操作
            function shipping() {
                var rows = $dg.datagrid("getChecked");
                var selected = [];
                $.each(rows, function (i, item) {
                    //console.log(item);
                    if (item.Status === "新增") {
                        selected.push(item);
                    }
                });
                if (selected.length > 0) {
                    $('#shippingwindow').window('open');
                    setshiporderdetaildg(selected);
                } else {
                    $.messager.alert("提示", "请选择新增的订单");
                }

            }
  //下载Excel导入模板
  function downloadtemplate() {
      //TODO: 修改下载模板的路径
      var url = "/ExcelTemplate/Order.xlsx";
      $.fileDownload(url)
          .fail(function() {
              $.messager.alert("错误", "没有找到模板文件! {" + url + "}");
          });

  }
  //打开Excel上传导入
  function importexcel() {
      $("#importwindow").window("open");
  }
  //执行Excel到处下载
  function exportexcel() {
      var filterRules = JSON.stringify($dg.datagrid("options").filterRules);
      //console.log(filterRules);
      $.messager.progress({
          title: "正在执行导出！"
      });
      var formData = new FormData();
      formData.append("filterRules", filterRules);
      formData.append("sort", "Id");
      formData.append("order", "asc");
      $.postDownload("/Orders/ExportExcel", formData, function(fileName) {
          $.messager.progress("close");
          console.log(fileName);

      })
  }
  //显示帮助信息
  function dohelp() {

            }
            //关闭发运窗口
            function closeshiporderwindow() {
                $('#shippingwindow').window('close');
            }
            var $shiporderdetailsdg = {};
            //创建发运单
            function createshiporder() {
                let $editform = $('#shiporder_form');
                if ($editform.form('enableValidation').form('validate')) {
                    var shiporder = $editform.serializeJSON();
                    var token = $('input[name="__RequestVerificationToken"]', $editform).val();
                    var shiporderdetails = $shiporderdetailsdg.datagrid("getData").rows;
                    var details = [];
                    $.each(shiporderdetails, function (i, item) {
                        item.OrderId = item.Id;
                        //item.id = 0;
                        details.push(item);
                    });
                    shiporder.ShipOrderDetails = details;
                
                    $.ajax({
                        type: "POST",
                        url: "/ShipOrders/CreateShipOrder",
                        data: {
                            __RequestVerificationToken: token,
                            shiporder: shiporder
                        },
                        dataType: 'json',
                        contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                    })
                        .done(function (response) {
                            if (response.success) {
                                $.messager.alert("提示", "保存成功！");
                                $('#shippingwindow').window("close");
                                $dg.datagrid('reload');
                            } else {
                                $.messager.alert("错误", "保存失败！" + response.err, "error");
                            }
                        })
                        .fail(function (response) {
                            $.messager.alert("错误", "保存失败！", "error");
                        });
                }

            }
            //加载配载订单数据
            function setshiporderdetaildg(data) {
                $.get("/ShipOrders/GetShipOrderNo", function (res) {
                    
                    $("#ShipOrderNo").textbox("setValue", res);
                });
                $('#Location11').textbox("setValue", data[0].Location1);
                $('#Location21').textbox("setValue", data[0].Location2);
                let p1 = 0;
                let p2 = 0;
                let p3 = 0;
                let p4 = 0;
                let p5 = 0;
                let p6 = 0;
               
                let passlocation = [];
                $.each(data, function (i, item) {
                    p1 += parseInt(item.Packages, 0)||0;
                    p2 += parseInt(item.Weight, 0) || 0;
                    p3 += parseInt(item.Volume, 0) || 0;
                    p4 += parseInt(item.Pallets, 0) || 0;
                    p5 += parseInt(item.Cartons, 0) || 0;
                    p6 += parseInt(item.BreakCartons, 0) || 0;
                    passlocation.push(item.Location1);
                    passlocation.push(item.Location2);
                });
                passlocation = passlocation.filter(function (item, pos) {
                    return passlocation.indexOf(item) == pos;
                })
                passlocation = passlocation.slice(2, passlocation.length)
                $('#TimePeriod1').val(data[0].TimePeriod.toString());
                $('#PassLocation').textbox("setValue", passlocation.join(","));
                $('#ItemCount1').val(data.length.toString());
                $('#Packages1').val(p1.toString());
                $('#Weight1').val(p2.toString());
                $('#Volume1').val(p3.toString());
                $('#Pallets1').val(p4.toString());
                $('#Cartons1').val(p5.toString());
                $('#BreakCartons1').val(p5.toString());
                $('#p1').html(p1);

                $('#p2').html(p2);
                $('#p3').html(p3);
                $('#p4').html(p4);
                $('#p5').html(p5);
                $('#p6').html(p6);

                $shiporderdetailsdg = $("#shiporderdetails_datagrid").datagrid({
                    rownumbers: true,
                    iconCls: 'fa fa-list',
                    idField: 'Id',
                    sortName: 'Id',
                    sortOrder: 'asc',
                    remoteFilter: false,
                    singleSelect: true,
                    data:data,
                    pagination: 'false',
                    striped: true,
                    columns: [[
                    														@* {
                    field: 'Id',
                    title: 'Id',
                    width: 80
                },*@
                {
                    field: 'OrderNo',
                    title: '订单号',
                    width: 140,
                    editor: {
                        type: 'textbox',
                        options: {
                            prompt: '订单号',
                            required: false, validType: 'length[0,20]'
                        }
                    }
                }, 
                {
                    field: 'Location1',
                        title: '起点',
                            width: 140,
                                editor: {
                        type: 'textbox',
                            options: {
                            prompt: '起点',
                                required: false, validType: 'length[0,120]'
                        }
                    }
                },
                {
                    field: 'LoadTransportStationName',
                        title: '装货点',
                            width: 140,
                                editor: {
                        type: 'textbox',
                            options: {
                            prompt: '装货点',
                                required: false, validType: 'length[0,50]'
                        }
                    }
                },
                {
                    field: 'Location2',
                        title: '终点',
                            width: 140,
                                editor: {
                        type: 'textbox',
                            options: {
                            prompt: '终点',
                                required: false, validType: 'length[0,120]'
                        }
                    }
                },
                {
                    field: 'ReceiptTransportStationName',
                        title: '卸货点',
                            width: 140,
                                editor: {
                        type: 'textbox',
                            options: {
                            prompt: '卸货点',
                                required: false, validType: 'length[0,50]'
                        }
                    }
                },
                {
                    field: 'Packages',
                        title: '总件数',
                            width: 100,
                                align: 'right',
                                    editor: {
                        type: 'numberbox',
                            options: {
                            prompt: '总件数',
                                required: false
                        }
                    } ,
                    sortable: true,
                        resizable: true
                },
                {
                    field: 'Weight',
                        title: '重量(千克)',
                            width: 100,
                                align: 'right',
                                    editor: {
                        type: 'numberbox',
                            options: {
                            prompt: '重量(千克)',
                                required: false
                        }
                    } ,
                    sortable: true,
                        resizable: true
                },
                {
                    field: 'Volume',
                        title: '体积(立方)',
                            width: 100,
                                align: 'right',
                                    editor: {
                        type: 'numberbox',
                            options: {
                            prompt: '体积(立方)',
                                required: false
                        }
                    } ,
                    sortable: true,
                        resizable: true
                },
                {
                    field: 'Pallets',
                        title: '栈板数',
                            width: 100,
                                align: 'right',
                                    editor: {
                        type: 'numberbox',
                            options: {
                            prompt: '栈板数',
                                required: false
                        }
                    } ,
                    sortable: true,
                        resizable: true
                },
                {
                    field: 'Cartons',
                        title: '箱数',
                            width: 100,
                                align: 'right',
                                    editor: {
                        type: 'numberbox',
                            options: {
                            prompt: '箱数',
                                required: false
                        }
                    } ,
                    sortable: true,
                        resizable: true
                },
                {
                    field: 'BreakCartons',
                        title: '散箱数',
                            width: 100,
                                align: 'right',
                                    editor: {
                        type: 'numberbox',
                            options: {
                            prompt: '散箱数',
                                required: false
                        }
                    } ,
                    sortable: true,
                        resizable: true
                } 
																		                    
                    
                    
                    ]]

                });

                $shiporderdetailsdg.datagrid('resize');
            }

  //datagrid 增删改查操作
  var $dg = $("#orders_datagrid").datagrid({
      rownumbers: true,
      checkOnSelect: true,
      selectOnCheck: true,
      idField: 'Id',
      sortName: 'Id',
      sortOrder: 'desc',
      remoteFilter: true,
      singleSelect: false,
      toolbar: '#orders_toolbar',
      url: '/Orders/GetData',
      method: 'get',
      onClickCell: onClickCell,
      pagination: true,
      striped: true,
      columns: [
          [
              { field: 'ck', checkbox: true },
              //{
              //    field: '_operate1',
              //    title: '操作',
              //    width: 120,
              //    sortable: false,
              //    resizable: true,
              //    formatter: showdetailsformatter
              //},
              /*{field:'Id',width:80 ,sortable:true,resizable:true }*/
              {
                  field: 'OrderNo',
                  title: '@Html.DisplayNameFor(model => model.OrderNo)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '派车单号',
                          required: false,
                          validType: 'length[0,20]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'ExternalNo',
                  title: '@Html.DisplayNameFor(model => model.ExternalNo)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '对账单号',
                          required: false,
                          validType: 'length[0,20]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'ShipperId',
                  title: '@Html.DisplayNameFor(model => model.ShipperId)',
                  width: 210,
                  sortable: true,
                  resizable: true,
                  formatter: function(value, row) {
                      return row.ShipperName;
                  },
                  editor: {
                      type: 'combobox',
                      options: {
                          prompt: '客户',
                          mode: 'remote',
                          valueField: 'Id',
                          textField: 'Name',
                          method: 'get',
                          url: '/Orders/GetShippers',
                          required: true
                      }
                  }
              },
              {
                  field: 'Status',
                  title: '@Html.DisplayNameFor(model => model.Status)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '状态',
                          required: false,
                          validType: 'length[0,20]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'OrderDate',
                  title: '@Html.DisplayNameFor(model => model.OrderDate)',
                  width: 160,
                  align: 'right',
                  editor: {
                      type: 'datetimebox',
                      options: {
                          prompt: '派车时间',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true,
                  formatter: datetimeformatter
              },
              {
                  field: 'Location1',
                  title: '@Html.DisplayNameFor(model => model.Location1)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '起点',
                          required: false,
                          validType: 'length[0,120]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Location2',
                  title: '@Html.DisplayNameFor(model => model.Location2)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '终点',
                          required: false,
                          validType: 'length[0,120]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Requirements',
                  title: '@Html.DisplayNameFor(model => model.Requirements)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '额外要求',
                          required: false,
                          validType: 'length[0,120]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'PlanDeliveryDate',
                  title: '@Html.DisplayNameFor(model => model.PlanDeliveryDate)',
                  width: 160,
                  align: 'right',
                  editor: {
                      type: 'datetimebox',
                      options: {
                          prompt: '计划送达时间',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true,
                  formatter: datetimeformatter
              },
              {
                  field: 'TimePeriod',
                  title: '@Html.DisplayNameFor(model => model.TimePeriod)',
                  width: 100,
                  align: 'right',
                  editor: {
                      type: 'numberbox',
                      options: {
                          prompt: '时效(小时)',
                          required: true
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Contact',
                  title: '@Html.DisplayNameFor(model => model.Contact)',
                  width: 120,
                  align: 'right',
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '联系电话',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'PhoneNumber',
                  title: '@Html.DisplayNameFor(model => model.PhoneNumber)',
                  width: 120,
                  align: 'right',
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '联系电话',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'VehicleId',
                  title: '@Html.DisplayNameFor(model => model.VehicleId)',
                  width: 160,
                  sortable: true,
                  resizable: true,
                  formatter: function(value, row) {
                      return row.VehiclePlateNumber;
                  },
                  editor: {
                      type: 'combogrid',
                      options: {
                          panelWidth: 500,
                          prompt: '车牌号',
                          mode: 'remote',
                          idField: 'Id',
                          textField: 'PlateNumber',
                          method: 'get',
                          url: '/Orders/GetAvailableVehicles',
                          required: true,
                          columns: [[
                              { field: 'PlateNumber', title: '车牌号', width: 120 },
                              { field: 'CarType', title: '车型', width: 80 },
                              { field: 'Status', title: '状态', width: 80 },
                              { field: 'StrLoadWeight', title: '载重', width: 80, align: 'right' },
                              { field: 'Driver', title: '司机', width: 80 },
                              { field: 'DriverPhone', title: '司机电话', width: 80 }
                          ]],
                          fitColumns: false,
                          onSelect: function (index, row) {
                              var rowdata = $dg.datagrid('getRows')[editIndex];
                              rowdata.PlateNumber = row.PlateNumber;
                              rowdata.Driver = row.Driver;
                              rowdata.DriverPhone = row.DriverPhone;
                              var ed1 = $dg.datagrid("getEditor", {
                                  index: editIndex,
                                  field: "PlateNumber"
                              });
                              $(ed1.target).textbox("setValue", row.PlateNumber);
                              var ed2 = $dg.datagrid("getEditor", {
                                  index: editIndex,
                                  field: "Driver"
                              });
                              $(ed2.target).textbox("setValue", row.Driver);
                              var ed3 = $dg.datagrid("getEditor", {
                                  index: editIndex,
                                  field: "DriverPhone"
                              });
                              $(ed3.target).textbox("setValue", row.DriverPhone);

                              //console.log(rowdata);
                          }
                      }
                  }
              },
              {
                  field: 'PlateNumber',
                  title: '@Html.DisplayNameFor(model => model.PlateNumber)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '车牌号',
                          required: true,
                          validType: 'length[0,10]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Driver',
                  title: '@Html.DisplayNameFor(model => model.Driver)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '主驾司机',
                          required: false,
                          validType: 'length[0,20]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'DriverPhone',
                  title: '@Html.DisplayNameFor(model => model.DriverPhone)',
                  width: 140,
                  editor: {
                      type: 'textbox',
                      options: {
                          prompt: '主驾司机电话',
                          required: false,
                          validType: 'length[0,50]'
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Packages',
                  title: '@Html.DisplayNameFor(model => model.Packages)',
                  width: 100,
                  align: 'right',
                  editor: {
                      type: 'numberbox',
                      options: {
                          prompt: '总件数',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Weight',
                  title: '@Html.DisplayNameFor(model => model.Weight)',
                  width: 100,
                  align: 'right',
                  editor: {
                      type: 'numberbox',
                      options: {
                          prompt: '重量(千克)',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Volume',
                  title: '@Html.DisplayNameFor(model => model.Volume)',
                  width: 100,
                  align: 'right',
                  editor: {
                      type: 'numberbox',
                      options: {
                          prompt: '体积(立方)',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Cartons',
                  title: '@Html.DisplayNameFor(model => model.Cartons)',
                  width: 100,
                  align: 'right',
                  editor: {
                      type: 'numberbox',
                      options: {
                          prompt: '箱数',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true
              },
              {
                  field: 'Pallets',
                  title: '@Html.DisplayNameFor(model => model.Pallets)',
                  width: 100,
                  align: 'right',
                  editor: {
                      type: 'numberbox',
                      options: {
                          prompt: '栈板数',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true
              },

              {
                  field: 'DeliveryDate',
                  title: '@Html.DisplayNameFor(model => model.DeliveryDate)',
                  width: 160,
                  align: 'right',
                  editor: {
                      type: 'datetimebox',
                      options: {
                          prompt: '实际送达时间',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true,
                  formatter: datetimeformatter
              },
              {
                  field: 'CloseDate',
                  title: '@Html.DisplayNameFor(model => model.CloseDate)',
                  width: 160,
                  align: 'right',
                  editor: {
                      type: 'datetimebox',
                      options: {
                          prompt: '结案时间',
                          required: false
                      }
                  },
                  sortable: true,
                  resizable: true,
                  formatter: datetimeformatter
              }

          ]
      ]

  });
  var editIndex = undefined;

  function reload() {
      if (endEditing()) {
          $dg.datagrid("reload");
      }
  }

  function endEditing() {
      if (editIndex == undefined) {
          return true
      }
      if ($dg.datagrid("validateRow", editIndex)) {

          var ed = $dg.datagrid("getEditor", {
              index: editIndex,
              field: "ShipperId"
          });
          var customername = $(ed.target).combobox("getText");
          var ShipperId = $(ed.target).combobox("getValue");

          $dg.datagrid("getRows")[editIndex]["CustomerName"] = customername;
          $dg.datagrid("getRows")[editIndex]["ShipperId"] = ShipperId;


          var ed = $dg.datagrid("getEditor", {
              index: editIndex,
              field: "VehicleId"
          });
          var vehicleplatenumber = $(ed.target).combogrid("getText");
          var vehicleid = $(ed.target).combogrid("getValue");

          $dg.datagrid("getRows")[editIndex]["VehiclePlateNumber"] = vehicleplatenumber;
          $dg.datagrid("getRows")[editIndex]["PlateNumber"] = vehicleplatenumber;
          $dg.datagrid("getRows")[editIndex]["VehicleId"] = vehicleid;


          $dg.datagrid("endEdit", editIndex);
          editIndex = undefined;


          return true;
      } else {
          return false;
      }
  }

  function onClickCell(index, field) {
      var _operates = ["_operate1", "_operate2", "_operate3", "ck"]
      var row = $dg.datagrid('getRows')[index];

      if ($.inArray(field, _operates) >= 0 || row.Status!="新增") {
          return;
      }
      if (editIndex != index) {
          if (endEditing()) {
              $dg.datagrid("selectRow", index)
                  .datagrid("beginEdit", index);
              editIndex = index;
              var ed = $dg.datagrid("getEditor", {
                  index: index,
                  field: field
              });
              if (ed) {
                  ($(ed.target).data("textbox") ? $(ed.target).textbox("textbox") : $(ed.target)).focus();
              }

          } else {
              $dg.datagrid("selectRow", editIndex);
          }
      }
  }

  function append() {
      if (endEditing()) {
          $('#myModal').modal('toggle');
          var ac1 = new BMap.Autocomplete(    //建立一个自动完成的对象
              {
                  "input": "Location1",
                  "location": "中国"


              });
          var ac2 = new BMap.Autocomplete(    //建立一个自动完成的对象
              {
                  "input": "Location2",
                  "location": "中国"
              });

      }
  }

  function removeit() {
      if (editIndex == undefined) {
          return
      }
      $dg.datagrid("cancelEdit", editIndex)
          .datagrid("deleteRow", editIndex);
      editIndex = undefined;
  }

  function accept() {
      if (endEditing()) {
          if ($dg.datagrid("getChanges").length) {
              var inserted = $dg.datagrid("getChanges", "inserted");
              var deleted = $dg.datagrid("getChanges", "deleted");
              var updated = $dg.datagrid("getChanges", "updated");
              var effectRow = new Object();
              if (inserted.length) {
                  effectRow.inserted = inserted;
              }
              if (deleted.length) {
                  effectRow.deleted = deleted;
              }
              if (updated.length) {
                  effectRow.updated = updated;
              }
              console.log(JSON.stringify(effectRow));
              $.post("/Orders/SaveData", effectRow, function(response) {
                  //console.log(response);
                  if (response.success) {
                      $.messager.alert("提示", "提交成功！");
                      $dg.datagrid("acceptChanges");
                      $dg.datagrid("reload");
                  } else {
                      $.messager.alert("错误", response.err);
                  }
              }, "json").fail(function(response) {
                  //console.log(response);
                  $.messager.alert("错误", "提交错误了！", "error");
                  //$dg.datagrid("reload");
              });

          }

          //$dg.datagrid("acceptChanges");
      }
  }

  function reject() {
      $dg.datagrid("rejectChanges");
      editIndex = undefined;
  }

  function getChanges() {
      var rows = $dg.datagrid("getChanges");
      alert(rows.length + " rows are changed!");
  }

  //datagrid 开启筛选功能
  $(function() {

      $dg.datagrid("enableFilter", [{
              field: "Status",
              type: "orderstatusfilter",

          },

          {
              field: "Id",
              type: "numberbox",
              op: ['equal', 'notequal', 'less', 'lessorequal', 'greater', 'greaterorequal']
          },
          {
              field: "TimePeriod",
              type: "numberbox",
              op: ['equal', 'notequal', 'less', 'lessorequal', 'greater', 'greaterorequal']
          },
          {
              field: "Packages",
              type: "numberbox",
              op: ['equal', 'notequal', 'less', 'lessorequal', 'greater', 'greaterorequal']
          },
          {
              field: "Weight",
              type: "numberbox",
              op: ['equal', 'notequal', 'less', 'lessorequal', 'greater', 'greaterorequal']
          },
          {
              field: "Volume",
              type: "numberbox",
              op: ['equal', 'notequal', 'less', 'lessorequal', 'greater', 'greaterorequal']
          },
          {
              field: "Cartons",
              type: "numberbox",
              op: ['equal', 'notequal', 'less', 'lessorequal', 'greater', 'greaterorequal']
          },
          {
              field: "Pallets",
              type: "numberbox",
              op: ['equal', 'notequal', 'less', 'lessorequal', 'greater', 'greaterorequal']
          },


          {
              field: "OrderDate",
              type: "dateRange",
              options: {
                  onChange: function(value) {
                      $dg.datagrid("addFilterRule", {
                          field: "OrderDate",
                          op: "between",
                          value: value
                      });

                      $dg.datagrid("doFilter");
                  }
              }
          },
          {
              field: "PlanDeliveryDate",
              type: "dateRange",
              options: {
                  onChange: function(value) {
                      $dg.datagrid("addFilterRule", {
                          field: "PlanDeliveryDate",
                          op: "between",
                          value: value
                      });

                      $dg.datagrid("doFilter");
                  }
              }
          },
          {
              field: "DeliveryDate",
              type: "dateRange",
              options: {
                  onChange: function(value) {
                      $dg.datagrid("addFilterRule", {
                          field: "DeliveryDate",
                          op: "between",
                          value: value
                      });

                      $dg.datagrid("doFilter");
                  }
              }
          },
          {
              field: "CloseDate",
              type: "dateRange",
              options: {
                  onChange: function(value) {
                      $dg.datagrid("addFilterRule", {
                          field: "CloseDate",
                          op: "between",
                          value: value
                      });

                      $dg.datagrid("doFilter");
                  }
              }
          },

          {
              field: "VehicleId",
              type: "combobox",
              options: {
                  valueField: "Id",
                  textField: "PlateNumber",
                  method: "get",
                  url: "/Orders/GetVehicles",
                  onChange: function(value) {
                      if (value == "") {
                          $dg.datagrid("removeFilterRule", "VehicleId");
                      } else {
                          $dg.datagrid("addFilterRule", {
                              field: "VehicleId",
                              op: "equal",
                              value: value
                          });
                      }
                      $dg.datagrid("doFilter");
                  }
              }
          },
          {
              field: "ShipperId",
              type: "combobox",
              options: {
                  valueField: "Id",
                  textField: "Name",
                  method: "get",
                  url: "/Orders/GetShippers",
                  onChange: function(value) {
                      if (value == "") {
                          $dg.datagrid("removeFilterRule", "ShipperId");
                      } else {
                          $dg.datagrid("addFilterRule", {
                              field: "ShipperId",
                              op: "equal",
                              value: value
                          });
                      }
                      $dg.datagrid("doFilter");
                  }
              }
          },

      ]);
  })
  //-----------------------------------------------------
  //datagrid onSelect
  //-----------------------------------------------------
  function showdetailsformatter(value, row, index) {

      return '<a onclick="showDetailsWindow(' + row.Id + ')" class="btn btn-default btn-sm" href="javascript:void(0)"><i class="fa fa-list"></i> 查看明细</a>';

  }
  //弹出明细信息
  function showDetailsWindow(id) {
      //console.log(index, row);
      $.getJSON('/Orders/PopupEdit/' + id, function(data, status, xhr) {
          //console.log(data);
          $('#detailswindow').window('open');
          loadData(id, data);


      });

  }


        $(document).ready(function () {

            $.validator.methods.inppc = function (value, element) {
                var patt = /^\d{1,5}\/\d{1,5}\/\d{1,5}$/;
                if (patt.test(value)) {
                    var numbers = value.match(/\d+/g).map(Number);

                    $('#Packages').val(numbers[0]);
                    $('#Pallets').val(numbers[1]);
                    $('#Cartons').val(numbers[2]);
                    return this.optional(element) || true;
                } else {
                    $('#Packages').val("");
                    $('#Pallets').val("");
                    $('#Cartons').val("");
                    return this.optional(element) || false;
                }


            }
            $.validator.methods.invw = function (value, element) {
                var patt = /^((\d{1,5}\.\d{0,2})|\d{1,5}$)\/(\d{1,5}\.\d{0,2})$|\d{1,5}$/;
                if (patt.test(value)) {
                    var numbers = value.match(/(\d+\.\d+)|\d+/g).map(Number);
                    $('#Volume').val(numbers[0]);
                    $('#Weight').val(numbers[1]);
                    return this.optional(element) || true;
                } else {
                    $('#Volume').val("");
                    $('#Weight').val("");
                    return this.optional(element) || false;
                }


            }
            var errorClass = 'invalid';
            var errorElement = 'em';
            var $form = $("#order-form").validate({
                errorClass: errorClass,
                errorElement: errorElement,
                highlight: function (element) {
                    $(element).parent().removeClass('state-success').addClass("state-error");
                    $(element).removeClass('valid');
                },
                unhighlight: function (element) {
                    $(element).parent().removeClass("state-error").addClass('state-success');
                    $(element).addClass('valid');
                },

                // Rules for form validation
                rules: {
                    ExternalNo: {
                        required: true,
                        maxlength: 30
                    },
                    ShipperId: {
                        required: true
                    },
                    Location1: {
                        required: true,
                        maxlength: 120
                    },
                    Location2: {
                        required: true,
                        maxlength: 120
                    },
                    PriceType: {
                        required: true
                    },
                    TimePeriod: {
                        required: true
                    },
                    inputloadsize: {
                        invw: true
                    },
                    inputloadnum: {
                        inppc: true
                    },
                    Contact: {
                        maxlength: 20
                    },
                    PhoneNumber: {
                        maxlength: 20
                    },
                    ResquestedLoadStartDatetime: {
                        required:true
                    }
                },

                // Messages for form validation
                messages: {
                    ExternalNo: {
                        required: '请输入客户对账单号'
                    },
                    PriceType: {
                        required: '请选择整车/拼车'
                    },
                    Location1: {
                        required: '请输入起点'
                    },
                    Location2: {
                        required: '请输入终点'
                    },
                    TimePeriod: {
                        required: '请输入时效'
                    },
                    inputloadsize: {
                        invw: '请输入体积(立方)[5位以内可带小数]/重量(吨)[5位以内可带小数]'
                    },
                    inputloadnum: {
                        inppc: '请输入件数[5位以内]/板数[5位以内]/箱数(或散箱数)[5位以内]'
                    }
                },

                // Do not change code below
                errorPlacement: function (error, element) {
                    error.insertAfter(element.parent());
                },
                submitHandler: function (form) {
                    var token = $('input[name="__RequestVerificationToken"]', form).val();
                    var data = $(form).serializeJSON();
                    console.log("do sumbit ", data);
                    $.post("/Orders/Create", {
                        __RequestVerificationToken: token,
                        order: data
                    }, function (res) {
                        //console.log(res);
                        if (res.success == false) {
                            $.messager.alert('错误', res.err);
                        } else {
                            $.messager.alert('提示', res.message);
                            $(form).resetForm();
                            $('#myModal').modal('toggle');
                        }
                    });
                }
            });


            $('#createorderbtn').click(function () {
                $("#order-form").submit();
            });


        });

        </script>
        <script src="~/Scripts/jquery.filerupload.js"></script>
    }


